<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í—ˆê·¸í•ìŠ¤íƒ€ì í•‘ - ì¶œì„ì²´í¬</title>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 420px;
            margin: 40px auto;
            padding: 24px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        .header img {
            width: 150px;
            margin-bottom: 16px;
        }
        .header h2 {
            color: #2e7d32;
            font-size: 20px;
            margin-top: 5px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            width: 100%;
            margin-top: 14px;
            padding: 14px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: #fff;
            font-size: 17px;
            cursor: pointer;
            font-weight: 600;
        }
        .success-message {
            display: none;
            margin-top: 40px;
            text-align: center;
            font-size: 1.3em;
            color: #2e7d32;
            font-weight: 700;
        }
        .fail-message {
            display: none;
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            background: #ffebee;
            color: #d32f2f;
            text-align: center;
        }
        .kakao-btn {
            width: 100%;
            margin-top: 22px;
            padding: 13px;
            display: block;
            background: #fee500;
            color: #000;
            text-align: center;
            border-radius: 6px;
            font-size: 16px;
            text-decoration: none;
            font-weight: 600;
        }
        #retryBtn {
            display: none;
            margin-top: 28px;
            background: #1976d2;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/silaskim-0722/hugfitmember-in/0cbe487104764f87d7939df2399a35f9672383c1/hugfit-logo.png" />
            <h2>í—ˆê·¸í• ì¶œì„ ì²´í¬</h2>
        </div>

        <form id="attendanceForm">
            <label>ì´ë¦„</label>
            <input type="text" id="name" placeholder="ì˜ˆ: ê¹€ë¯¼ì •" required />

            <label>ì „í™”ë²ˆí˜¸ ë’·ìë¦¬</label>
            <input type="tel" id="phone" maxlength="4" pattern="[0-9]{4}" placeholder="ì˜ˆ: 1234" required />

            <div id="today" style="text-align:center; margin-top:15px; color:#666;"></div>

            <button type="submit">ì¶œì„ì™„ë£Œ</button>
        </form>

        <div id="successMessage" class="success-message"></div>
        <div id="failMessage" class="fail-message">ë“±ë¡ëœ ê³ ê°ì´ ì•„ë‹™ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>

        <button id="retryBtn">ë‹¤ì‹œ ì¶œì„í•˜ê¸°</button>

        <a class="kakao-btn" href="https://open.kakao.com/me/fitcouple" target="_blank">ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜í•˜ê¸°</a>
    </div>

<script>
    // Airtable ì„¤ì •
    const AIRTABLE_API_KEY = "YOUR_API_KEY";
    const AIRTABLE_BASE_ID = "YOUR_BASE_ID";
    const TABLE = "ê³ ê°";

    // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const todayStr = `${yyyy}-${mm}-${dd}`;
    document.getElementById("today").textContent = "ì˜¤ëŠ˜ ë‚ ì§œ: " + todayStr;

    // Airtableì—ì„œ ê³ ê° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function getCustomers() {
        const res = await fetch(
            `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(TABLE)}`,
            { headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` } }
        );
        const json = await res.json();
        return json.records.map(r => ({ id: r.id, ...r.fields }));
    }

    // Airtable ê°’ ì—…ë°ì´íŠ¸
    async function updateRecord(id, fields) {
        await fetch(
            `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLE}/${id}`,
            {
                method: "PATCH",
                headers: {
                    Authorization: `Bearer ${AIRTABLE_API_KEY}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ fields }),
            }
        );
    }

    // ë‹¹ì¼ ì¶œì„ ì—¬ë¶€ í™•ì¸
    function isSameDay(dateStr) {
        return dateStr === todayStr;
    }

    document.getElementById("attendanceForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();

        const customers = await getCustomers();
        const user = customers.find(c => c["ì´ë¦„"] === name && c["ì „í™”ë²ˆí˜¸ë’·ìë¦¬"] === phone);

        const success = document.getElementById("successMessage");
        const fail = document.getElementById("failMessage");

        success.style.display = "none";
        fail.style.display = "none";

        if (!user) {
            fail.style.display = "block";
            return;
        }

        // ğŸ”¥ ì¤‘ë³µ ì¶œì„ ë°©ì§€ (ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„í•œ ê²½ìš°)
        if (isSameDay(user["ìµœê·¼ë°©ë¬¸ì¼"])) {
            document.getElementById("attendanceForm").style.display = "none";
            success.innerHTML = `${name} ë‹˜ì€ ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.<br><br>(${todayStr})`;
            success.style.display = "block";
            document.getElementById("retryBtn").style.display = "block";
            return;
        }

        // ì¶œì„ ì²˜ë¦¬
        let msg = `${name} ë‹˜ì˜ ${todayStr} ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>`;

        if (user["ìœ í˜•"] === "ì¿ í°") {
            let remain = user["ë‚¨ì€íšŸìˆ˜/ê¸°ê°„"] || 0;

            if (remain > 0) remain -= 1;

            await updateRecord(user.id, {
                "ë‚¨ì€íšŸìˆ˜/ê¸°ê°„": remain,
                "ìµœê·¼ë°©ë¬¸ì¼": todayStr
            });

            msg += `<br>ë‚¨ì€ ì¿ í°: <b>${remain}</b>íšŒ`;

        } else if (user["ìœ í˜•"] === "ê¸°ê°„") {
            let start = new Date(user["ê¸°ê°„ì‹œì‘ì¼"]);
            let option = user["ì˜µì…˜"];   // ì˜ˆ: "1ê°œì›”", "3ê°œì›”"

            const months = parseInt(option) || 1;
            let expireDate = new Date(start);
            expireDate.setMonth(expireDate.getMonth() + months);

            const expY = expireDate.getFullYear();
            const expM = String(expireDate.getMonth() + 1).padStart(2, "0");
            const expD = String(expireDate.getDate()).padStart(2, "0");

            await updateRecord(user.id, { "ìµœê·¼ë°©ë¬¸ì¼": todayStr });

            msg += `<br>ë§Œë£Œì¼: <b>${expY}-${expM}-${expD}</b>`;
        }

        document.getElementById("attendanceForm").style.display = "none";
        success.innerHTML = msg;
        success.style.display = "block";
        document.getElementById("retryBtn").style.display = "block";
    });

    document.getElementById("retryBtn").addEventListener("click", function () {
        document.getElementById("attendanceForm").reset();
        document.getElementById("attendanceForm").style.display = "block";
        document.getElementById("successMessage").style.display = "none";
        document.getElementById("retryBtn").style.display = "none";
    });
</script>
</body>
</html>
